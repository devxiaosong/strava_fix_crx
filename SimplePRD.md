# Strava Bulk Edit Extension - MVP 版本 PRD

## 📝 文档信息

**版本**: v1.0-MVP  
**创建日期**: 2025-01-07  
**产品负责人**: Stone  
**状态**: 📝 规划中  
**目标**: 快速上架，验证核心价值

---

## 🎯 MVP 版本目标

### 核心目标

**快速上架，对标竞品，验证市场**

1. **快速上架** - 2-3 周内完成开发并提交审核
2. **对标竞品** - 覆盖竞品 updateActivities.js 的所有功能
3. **验证价值** - 验证批量编辑的用户需求和产品价值
4. **技术验证** - 验证基于快捷更新的技术方案可行性

### 成功标准

- ✅ 功能完整性：覆盖竞品的 4 个字段编辑功能
- ✅ 用户体验：提供完整的操作流程和进度反馈
- ✅ 稳定性：基本的错误处理，不会导致数据错误
- ✅ 上架时间：3 周内完成开发并提交 Chrome 应用商店

### MVP 策略

**做减法，不做加法**：
- ✅ 保留完整的用户操作流程
- ✅ 保留核心功能（4个字段）
- ❌ 不实现配置化系统
- ❌ 不实现规则引擎
- ❌ 不实现付费功能
- ❌ 不实现多条规则

**技术权衡**：
- 硬编码实现，快速上线
- 架构分层清晰，为 V2.0 预留扩展空间
- 先验证价值，再投入完整开发

---

## 前端页面元素

列表字段：
Sport: Rune
Date: Tue, 12/30/2025 (可排序)
Title: 晚间骑行001 (可排序)
Time: 4:10:54	 (可排序)
Distance: 78.06 mi
Elevation: 0 ft (可排序)

快捷编辑字段：
Title
Description
Privacy Controls: Everyone, Followers, Only You
Sport：Ride, Run
------------------------
Spor == Run
Run Type：Run, Race, Workout, Long Run
Shoes：用户自定义列表
Treadmill (Checkbox)
------------------------
Spor == Ride
Ride Type: Ride, Race, Workout
Commute: Checkbox
Indoor Cycling: Checkbox
------------------------

---

## API请求

获取列表的请求：
GET https://www.strava.com/athlete/training_activities?keywords=&sport_type=&tags=&commute=&private_activities=&trainer=&gear=&search_session_id=713a4fa7-6e72-4636-ba77-0ac44efd3f13&new_activity_only=false

{
    "models": [
        {
            "id": 16922821055,
            "name": "晚间骑行001",
            "sport_type": "Run",
            "display_type": "Run",
            "activity_type_display_name": "Run",
            "private": false,
            "bike_id": null,
            "athlete_gear_id": null,
            "start_date": "Tue, 12/30/2025",
            "start_date_local_raw": 1767056400,
            "start_time": "2025-12-30T00:00:00+0000",
            "start_day": "Tue",
            "distance": "78.06",
            "distance_raw": 125626.0,
            "long_unit": "miles",
            "short_unit": "mi",
            "moving_time": "4:10:54",
            "moving_time_raw": 15054,
            "elapsed_time": "4:10:54",
            "elapsed_time_raw": 15054,
            "trainer": true,
            "static_map": null,
            "has_latlng": true,
            "commute": null,
            "elevation_gain": "0",
            "elevation_unit": "ft",
            "elevation_gain_raw": 0,
            "description": "",
            "activity_url": "https://www.strava.com/activities/16922821055",
            "activity_url_for_twitter": "https://www.strava.com/activities/16922821055?utm_content=154862811\u0026utm_medium=referral\u0026utm_source=twitter",
            "twitter_msg": "went for a 78.0 mile Run.",
            "is_changing_type": false,
            "suffer_score": null,
            "tags": {
                "6": false,
                "8": false,
                "9": false,
                "2": true,
                "7": false,
                "4": false,
                "11": false,
                "15": false,
                "10": false,
                "5": true
            },
            "selected_tag_type": 2,
            "flagged": false,
            "hide_power": false,
            "hide_heartrate": false,
            "visibility": "followers_only"
        }
    ],
    "page": 1,
    "perPage": 20,
    "total": 1
}


快捷修改的请求：
PUT https://www.strava.com/athlete/training_activities/16922821055
request body：{"id":16922821055,"name":"晚间骑行001","sport_type":"Run","display_type":"Run","activity_type_display_name":"Run","private":false,"bike_id":"","athlete_gear_id":"","start_date":"Tue, 12/30/2025","start_date_local_raw":1767056400,"start_time":"2025-12-30T00:00:00+0000","start_day":"Tue","distance":"78.06","distance_raw":125626,"long_unit":"miles","short_unit":"mi","moving_time":"4:10:54","moving_time_raw":15054,"elapsed_time":"4:10:54","elapsed_time_raw":15054,"trainer":true,"static_map":null,"has_latlng":true,"commute":false,"elevation_gain":"0","elevation_unit":"ft","elevation_gain_raw":0,"description":"","activity_url":"https://www.strava.com/activities/16922821055","activity_url_for_twitter":"https://www.strava.com/activities/16922821055?utm_content=154862811&utm_medium=referral&utm_source=twitter","twitter_msg":"went for a 78.0 mile Run.","is_changing_type":false,"suffer_score":null,"tags":{"2":true,"4":false,"5":true,"6":false,"7":false,"8":false,"9":false,"10":false,"11":false,"15":false},"selected_tag_type":2,"flagged":false,"hide_power":false,"hide_heartrate":false,"visibility":"everyone","tag_type":"2","tag_type_ride":"2","tag_type_run":"2"}
rsp 
{
    "id": 16922821055,
    "name": "晚间骑行001",
    "sport_type": "Run",
    "display_type": "Run",
    "activity_type_display_name": "Run",
    "private": false,
    "bike_id": null,
    "athlete_gear_id": null,
    "start_date": "Tue, 12/30/2025",
    "start_date_local_raw": 1767056400,
    "start_time": "2025-12-30T00:00:00+0000",
    "start_day": "Tue",
    "distance": "78.06",
    "distance_raw": 125626.0,
    "long_unit": "miles",
    "short_unit": "mi",
    "moving_time": "4:10:54",
    "moving_time_raw": 15054,
    "elapsed_time": "4:10:54",
    "elapsed_time_raw": 15054,
    "trainer": true,
    "static_map": null,
    "has_latlng": true,
    "commute": false,
    "elevation_gain": "0",
    "elevation_unit": "ft",
    "elevation_gain_raw": 0,
    "description": "",
    "activity_url": "https://www.strava.com/activities/16922821055",
    "activity_url_for_twitter": "https://www.strava.com/activities/16922821055?utm_content=154862811\u0026utm_medium=referral\u0026utm_source=twitter",
    "twitter_msg": "went for a 78.0 mile Run.",
    "is_changing_type": false,
    "suffer_score": null,
    "tags": {
        "6": false,
        "8": false,
        "9": false,
        "2": true,
        "7": false,
        "4": false,
        "11": false,
        "15": false,
        "10": false,
        "5": false
    },
    "selected_tag_type": 2,
    "flagged": false,
    "hide_power": false,
    "hide_heartrate": false,
    "visibility": "everyone"
}

---

## 📦 功能范围

### 支持的字段（对标竞品）

V1.0 支持 **4 种批量操作场景**：

| 场景编号 | 操作场景 | 适用运动 | 可附带更新隐私 | 竞品支持 |
|---------|---------|---------|--------------|---------|
| S1 | 批量更新自行车 | 骑行 | ✅ | ✅ |
| S2 | 批量更新跑鞋 | 跑步 | ✅ | ✅ |
| S3 | 调整活动隐私设置 | 所有 | - | ✅ |
| S4 | 标记骑行类型 | 骑行 | ✅ | ✅ |

**说明**：
- 每次选择一种操作场景
- 所有符合条件的活动统一更新
- 场景 S1、S2、S4 可以附带更新隐私设置（可选）
- 如需执行多种操作，可以多次运行

---

### 筛选条件（匹配规则）

V1.0 支持的筛选条件：

**运动类型**：
- 根据场景自动设置或可选
- 骑行场景：固定为"骑行"
- 跑步场景：固定为"跑步"
- 隐私场景：可多选"骑行"和"跑步"

**时间范围**（可选）：
- 默认为空（不限时间）
- 可添加多个时间段
- 每个时间段包含起始日期和结束日期
- 可随时添加或删除时间段

**距离范围**：
- 使用滑块控件调整
- 骑行：默认 0-300 km
- 跑步：默认 0-40 km
- 标记骑行：默认 0-300 km

**骑行类型**（仅骑行相关场景）：
- 下拉多选组件
- 可选：Race、Workout、Long Ride、Commute
- 默认为空（匹配所有类型）

**说明**：
- 所有筛选条件是"且"关系（必须同时满足）
- 不设置的条件表示不限制

---

### 不支持的功能

**明确不支持的操作**：
- ❌ 运动类型转换（如骑行改跑步）
- ❌ 活动名称批量修改
- ❌ 活动描述批量修改
- ❌ 标签批量管理
- ❌ 跑步训练类型（Workout Type）批量标记

**技术限制**：
- ❌ 场景配置化（当前硬编码）
- ❌ DOM 选择器配置化（当前硬编码）
- ❌ 多条规则（只支持单条）
- ❌ 规则模板保存

**商业功能**：
- ❌ 付费功能
- ❌ 用户权限系统

---

## 🔄 用户操作流程

### 整体流程概览

```
用户访问 Strava 训练页面
    ↓
看到"批量更新"按钮
    ↓
点击按钮 → 打开配置对话框
    ↓
步骤 1: 选择操作场景
    ↓
步骤 2: 配置筛选条件和更新值
    ↓
预览匹配结果（可选）
    ↓
执行批量更新
    ↓
查看执行结果
```

---

### 详细步骤

#### 步骤 0: 入口

**位置**: Strava 训练日志页面的搜索筛选面板附近  
**触发**: 插件自动在页面植入 **"批量更新"** 按钮

**按钮样式**：
- 使用 Strava 原生按钮样式
- 文字："批量更新" 或 "Bulk Edit"
- 位置：搜索面板下方

---

#### 步骤 1: 选择操作场景

**UI**: 配置对话框第一步

**情况 A - 没有未完成任务**：

```
┌─────────────────────────────────────┐
│ 批量更新 - 选择操作                   │
├─────────────────────────────────────┤
│                                     │
│ 你想要：                             │
│                                     │
│ ( ) 🔒 调整活动隐私设置               │
│     控制活动的可见范围               │
│                                     │
│ ( ) 👟 批量更新跑鞋                  │
│     记录跑鞋的使用情况               │
│                                     │
│ ( ) 🚴 批量更新自行车                │
│     记录骑行装备的使用情况            │
│                                     │
│ ( ) 🏷️  标记骑行类型                 │
│     区分训练、比赛、长骑等            │
│                                     │
├─────────────────────────────────────┤
│ [取消] [下一步]                      │
└─────────────────────────────────────┘
```

**情况 B - 有未完成任务**：

```
┌─────────────────────────────────────┐
│ 批量更新 - 选择操作                   │
├─────────────────────────────────────┤
│                                     │
│ 开始新任务：                         │
│                                     │
│ ( ) 🚴 批量更新自行车                │
│                                     │
│ ( ) 👟 批量更新跑鞋                  │
│                                     │
│ ( ) 🔒 调整活动隐私设置               │
│                                     │
│ ( ) 🏷️  标记骑行类型                 │
│                                     │
├─────────────────────────────────────┤
│                                     │
│ ⚠️  未完成的任务：                   │
│                                     │
│ 👟 批量更新跑鞋                      │
│ 📊 进度：3/8 页 (37%)               │
│ 📈 已处理：8 个活动 (成功7, 失败1)   │
│                                     │
│ [继续执行] [查看详情] [放弃任务]      │
│                                     │
├─────────────────────────────────────┤
│ [取消] [下一步]                      │
└─────────────────────────────────────┘
```

**说明**：
- 单选按钮，选择一种操作
- 每个场景都有清晰的使用说明
- 如果有未完成任务，显示在场景列表下方
- 用户可以选择继续未完成任务或开始新任务

**入口按钮状态**：
- 正常：`[批量更新]`
- 有未完成任务：`[批量更新 🔴]` - 显示红色角标提示

---

#### 步骤 2: 配置筛选条件和更新值

**说明**：根据选择的场景，显示对应的配置界面

---

##### 场景 1：🚴 批量更新自行车

```
┌─────────────────────────────────────┐
│ 🚴 批量更新自行车                     │
├─────────────────────────────────────┤
│                                     │
│ 【筛选条件】                         │
│                                     │
│ 运动类型：骑行 🔒                    │
│  💡 仅对骑行活动生效，不可修改        │
│                                     │
│ 时间范围（可选）：                    │
│  💡 默认为空，不限时间               │
│  [+ 添加时间段]                     │
│                                     │
│ 距离范围：                           │
│  [━━━●━━━━━━━━━━━━━━━━━●━━━]        │
│  0 km        150 km        300 km  │
│  💡 拖动滑块调整范围，默认 0-300km    │
│                                     │
│ 骑行类型（可选）：                    │
│  [下拉多选: 选择骑行类型... ▼]       │
│    Race                            │
│    Workout                         │
│    Long Ride                       │
│  💡 默认为空，匹配所有类型            │
│                                     │
├─────────────────────────────────────┤
│ 【更新为】                           │
│                                     │
│ 选择自行车：*必填                    │
│ [下拉选择 ▼]                        │
│  • Canyon Aeroad CF SLX            │
│  • Giant TCR Advanced              │
│  • Specialized Allez               │
│  • ...                             │
│                                     │
│ 💡 从您的 Strava 装备库中读取         │
│                                     │
│ 同时更新隐私设置（可选）：            │
│ [ ] 更新隐私                        │
│     [下拉选择 ▼]                    │
│      • 所有人                       │
│      • 仅关注者                     │
│      • 仅自己                       │
│                                     │
├─────────────────────────────────────┤
│ [上一步] [取消] [预览] [直接执行]     │
└─────────────────────────────────────┘
```

**添加时间段后的界面**：

```
│ 时间范围（可选）：                    │
│  ┌────────────────────────────────┐ │
│  │ 📅 2024/01/01 - 2024/02/28     │ │
│  │                     [删除]      │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ 📅 2024/06/01 - 2024/06/30     │ │
│  │                     [删除]      │ │
│  └────────────────────────────────┘ │
│  [+ 添加时间段]                     │
```

---

##### 场景 2：👟 批量更新跑鞋

```
┌─────────────────────────────────────┐
│ 👟 批量更新跑鞋                      │
├─────────────────────────────────────┤
│                                     │
│ 【筛选条件】                         │
│                                     │
│ 运动类型：跑步 🔒                    │
│  💡 仅对跑步活动生效，不可修改        │
│                                     │
│ 时间范围（可选）：                    │
│  💡 默认为空，不限时间               │
│  [+ 添加时间段]                     │
│                                     │
│ 距离范围：                           │
│  [━━━●━━━━━━━━━━━━━━━━━●━━━]        │
│  0 km         20 km         40 km  │
│  💡 拖动滑块调整范围，默认 0-40km     │
│                                     │
├─────────────────────────────────────┤
│ 【更新为】                           │
│                                     │
│ 选择跑鞋：*必填                      │
│ [下拉选择 ▼]                        │
│  • Nike Pegasus 40                 │
│  • Hoka Clifton 9                  │
│  • Asics Gel-Kayano 29             │
│  • ...                             │
│                                     │
│ 💡 从您的 Strava 装备库中读取         │
│                                     │
│ 同时更新隐私设置（可选）：            │
│ [ ] 更新隐私                        │
│     [下拉选择 ▼]                    │
│      • 所有人                       │
│      • 仅关注者                     │
│      • 仅自己                       │
│                                     │
├─────────────────────────────────────┤
│ [上一步] [取消] [预览] [直接执行]     │
└─────────────────────────────────────┘
```

---

##### 场景 3：🔒 调整活动隐私设置

```
┌─────────────────────────────────────┐
│ 🔒 调整活动隐私设置                   │
├─────────────────────────────────────┤
│                                     │
│ 【筛选条件】                         │
│                                     │
│ 运动类型：                           │
│  [下拉多选: 骑行, 跑步 ▼]           │
│  💡 默认全选，至少选择一个            │
│                                     │
│ 时间范围（可选）：                    │
│  💡 默认为空，不限时间               │
│  [+ 添加时间段]                     │
│                                     │
├─────────────────────────────────────┤
│ 【更新为】                           │
│                                     │
│ 设置可见范围：*必填                  │
│                                     │
│ [下拉选择 ▼]                        │
│  • 所有人 (Everyone)                │
│    任何人都可以看到此活动             │
│                                     │
│  • 仅关注者 (Followers)             │
│    只有关注你的人可以看到             │
│                                     │
│  • 仅自己 (Only Me)                 │
│    只有你自己可以看到                │
│                                     │
├─────────────────────────────────────┤
│ [上一步] [取消] [预览] [直接执行]     │
└─────────────────────────────────────┘
```

---

##### 场景 4：🏷️ 标记骑行类型

```
┌─────────────────────────────────────┐
│ 🏷️  标记骑行类型                     │
├─────────────────────────────────────┤
│                                     │
│ 【筛选条件】                         │
│                                     │
│ 运动类型：骑行 🔒                    │
│  💡 仅对骑行活动生效，不可修改        │
│                                     │
│ 时间范围（可选）：                    │
│  💡 默认为空，不限时间               │
│  [+ 添加时间段]                     │
│                                     │
│ 距离范围：                           │
│  [━━━●━━━━━━━━━━━━━━━━━●━━━]        │
│  0 km        150 km        300 km  │
│  💡 拖动滑块调整范围，默认 0-300km    │
│                                     │
├─────────────────────────────────────┤
│ 【更新为】                           │
│                                     │
│ 选择类型：*必填                      │
│                                     │
│ [下拉选择 ▼]                        │
│  • Race (比赛)                     │
│    竞赛或计时赛                      │
│                                     │
│  • Workout (训练)                  │
│    日常训练                         │
│                                     │
│  • Long Ride (长骑)                │
│    长距离耐力骑行                    │
│                                     │
│  • Commute (通勤)                  │
│    上下班通勤                       │
│                                     │
│ 同时更新隐私设置（可选）：            │
│ [ ] 更新隐私                        │
│     [下拉选择 ▼]                    │
│      • 所有人                       │
│      • 仅关注者                     │
│      • 仅自己                       │
│                                     │
├─────────────────────────────────────┤
│ [上一步] [取消] [预览] [直接执行]     │
└─────────────────────────────────────┘
```

---

**界面特点**：
- 每个场景有独立的配置界面
- 筛选条件和更新值在同一页面
- 运动类型根据场景固定（🔒）或可选
- 时间范围：默认为空（不限），可添加多个时间段
- 距离/时长范围：使用滑块控件，有默认范围
- 骑行类型：下拉多选，默认为空（匹配所有）
- 所有筛选条件是"且"关系
- 除隐私场景外，其他场景可附带更新隐私设置（可选）

**操作按钮**：
- **上一步**：返回场景选择
- **取消**：放弃本次操作
- **预览**：查看将要更新哪些活动
- **直接执行**：跳过预览，立即执行

---

#### 步骤 3: 预览匹配结果（可选）

**触发**: 用户点击"预览"按钮

**预览过程显示**：

```
┌──────────────────────────────────────┐
│  正在预览...                          │
├──────────────────────────────────────┤
│                                      │
│  正在遍历活动列表...                  │
│                                      │
│  当前页面：第 3 / 共 8 页             │
│  已检查：45 个活动                    │
│  符合条件：12 个活动                  │
│                                      │
│  进度：[███████░░░░░] 37%            │
│                                      │
│  [取消预览]                          │
└──────────────────────────────────────┘
```

**预览结果显示**：

```
┌──────────────────────────────────────┐
│  预览完成                             │
├──────────────────────────────────────┤
│  符合条件的活动：12 个                │
│  操作：批量更新跑鞋                   │
│  更新为：Nike Pegasus 40              │
│                                      │
│  将要修改的活动列表：                 │
│  ┌────────────────────────────────┐ │
│  │ • 2024-01-15 早晨跑步 (5.2km)  │ │
│  │   跑鞋: (无) → Nike Pegasus 40 │ │
│  │                                │ │
│  │ • 2024-01-18 训练 (8.5km)      │ │
│  │   跑鞋: Hoka → Nike Pegasus 40 │ │
│  │                                │ │
│  │ • 2024-01-20 LSD (15.3km)      │ │
│  │   跑鞋: (无) → Nike Pegasus 40 │ │
│  │                                │ │
│  │ ... 展开查看全部 12 个活动      │ │
│  └────────────────────────────────┘ │
│                                      │
│  [返回修改] [取消] [开始执行]         │
└──────────────────────────────────────┘
```

**说明**：
- 预览不修改任何数据，只模拟
- 显示所有匹配的活动和修改内容
- 可滚动查看所有活动
- 用户可以返回修改条件

---

#### 步骤 4: 执行批量更新

**触发**: 
- 用户在步骤3点击"直接执行"
- 或在预览结果点击"开始执行"

**执行过程显示**：

```
┌──────────────────────────────────────┐
│  正在执行批量更新...                  │
├──────────────────────────────────────┤
│                                      │
│  翻页进度：第 3 / 共 8 页             │
│  已处理活动：8 / 12 个                │
│                                      │
│  ✅ 成功：7 个                        │
│  ❌ 失败：1 个                        │
│                                      │
│  翻页进度：[█████░░░] 37% (3/8页)    │
│  预计剩余时间：约 1 分钟              │
│                                      │
│  [暂停]                              │
└──────────────────────────────────────┘
```

**说明**：
- 进度条显示的是翻页进度（已处理页数/总页数）
- 而非活动处理进度
- 因为需要遍历所有页面才能找到符合条件的活动

**说明**：
- 实时显示进度
- 显示成功/失败数量
- 可以随时暂停
- 显示预计剩余时间

---

#### 步骤 5: 执行结果

**执行完成后显示**：

```
┌──────────────────────────────────────┐
│  批量更新完成 ✅                      │
├──────────────────────────────────────┤
│                                      │
│  ✅ 成功更新：11 个活动               │
│  ❌ 失败：1 个活动                    │
│                                      │
│  失败详情：                           │
│  • 活动 "早晨跑步" (2024-01-22):     │
│    网络错误，已重试 3 次              │
│                                      │
│  总耗时：2 分 15 秒                   │
│                                      │
│  [关闭]                              │
└──────────────────────────────────────┘
```

**说明**：
- 显示成功和失败数量
- 列出失败的活动和原因
- 显示总耗时
- 点击关闭后自动刷新页面

---

#### 暂停功能

**触发**: 执行过程中点击"暂停"按钮

**暂停后显示**：

```
┌──────────────────────────────────────┐
│  已暂停                               │
├──────────────────────────────────────┤
│                                      │
│  翻页进度：已处理 3 / 8 页            │
│  已处理活动：15 个                    │
│  成功：14 个，失败：1 个              │
│                                      │
│  [继续] [停止并保存]                  │
└──────────────────────────────────────┘
```

**说明**：
- **继续**：从当前页面继续处理
- **停止并保存**：
  - 保存任务状态和进度
  - 已修改的数据保留，不撤销
  - 下次打开可以继续执行

---

#### 继续执行未完成任务

**功能说明**：
- 支持暂停后继续执行
- 异常中断后可恢复
- 任务状态自动保存

**任务保存**：
- 存储位置：Chrome Storage (chrome.storage.local)
- 保存内容：场景配置、筛选条件、更新值、执行进度
- 过期时间：24 小时自动清理
- 任务数量：只保留最近一个未完成任务

**触发场景**：
1. 用户主动暂停任务
2. 异常中断（浏览器崩溃、标签页关闭等）
3. 检测到连续失败自动暂停

---

##### 查看详情对话框

```
┌─────────────────────────────────────┐
│ 任务详情                             │
├─────────────────────────────────────┤
│                                     │
│ 场景：👟 批量更新跑鞋                │
│                                     │
│ 【筛选条件】                         │
│ • 运动类型：跑步                     │
│ • 时间范围：2024/01/01 - 2024/02/28 │
│ • 距离范围：> 10 km                 │
│                                     │
│ 【更新值】                           │
│ • 跑鞋：Nike Pegasus 40              │
│ • 隐私：仅关注者                     │
│                                     │
│ 【执行状态】                         │
│ • 总页数：8 页                      │
│ • 已处理：3 页 (37%)                │
│ • 成功活动：7 个                    │
│ • 失败活动：1 个                    │
│   - 活动#12345: 网络错误            │
│ • 暂停时间：2024-01-07 10:05        │
│                                     │
│ [返回] [继续执行] [放弃任务]         │
└─────────────────────────────────────┘
```

---

##### 放弃任务确认对话框

```
┌─────────────────────────────────────┐
│ 确认放弃任务                         │
├─────────────────────────────────────┤
│                                     │
│ 确定要放弃这个任务吗？                │
│                                     │
│ 👟 批量更新跑鞋                      │
│ 进度：3/8 页 (37%)                  │
│                                     │
│ ⚠️  已处理的 7 个活动不会回滚         │
│    任务记录将被删除                  │
│                                     │
│ [取消] [确认放弃]                    │
└─────────────────────────────────────┘
```

---

##### 继续执行界面

```
┌──────────────────────────────────────┐
│  继续执行：批量更新跑鞋               │
├──────────────────────────────────────┤
│                                      │
│  📋 上次配置：                        │
│  • 时间：2024/01-02月                │
│  • 距离：> 10 km                     │
│  • 更新为：Nike Pegasus 40           │
│                                      │
│  📊 上次进度：                        │
│  • 已处理：3/8 页                    │
│  • 成功：7 个，失败：1 个             │
│                                      │
│  ⚡ 将从第 4 页继续执行                │
│                                      │
├──────────────────────────────────────┤
│  翻页进度：第 4 / 共 8 页             │
│  已处理活动：10 个                    │
│  ✅ 成功：9 个                        │
│  ❌ 失败：1 个                        │
│  翻页进度：[██████░░] 50% (4/8页)    │
│  [暂停]                              │
└──────────────────────────────────────┘
```

**执行逻辑**：
- 读取保存的任务状态
- 恢复配置（筛选条件、更新值）
- 从上次暂停的页面继续
- 失败的活动自动重试一次
- 完成后更新任务状态或删除任务

---

## 🎯 核心功能实现

### 1. 批量更新逻辑

**核心流程**：

```
1. 用户完成配置（场景、筛选条件、更新值）
   ↓
2. 点击快速编辑按钮（打开所有活动的编辑表单）
   ↓
3. 遍历每个活动：
   - 检查是否符合筛选条件
   - 如果符合，填充修改值
   - 如果不符合，跳过
   ↓
4. 提交所有修改的活动
   ↓
5. 检查是否有下一页
   - 如果有，点击下一页按钮
   - 等待页面加载完成
   - 重复步骤 2-5
   - 如果没有，完成
   ↓
6. 显示执行结果
```

---

### 2. 页面加载检测

**问题**：翻页后如何知道新页面已加载完成？

**实现方案**：简单延迟 + DOM 检测

```
点击"下一页"按钮
  ↓
等待 2 秒（固定延迟）
  ↓
检测页面状态：
- 检查活动列表容器是否更新
- 检查高亮的页码是否改变
  ↓
如果检测通过，继续
如果检测失败，再等待 1 秒后重试（最多 3 次）
```

**说明**：
- 使用简单的固定延迟（参考竞品做法）
- 已验证可靠性

---

### 3. 错误处理

**基础错误处理**：

**网络错误**：
- 自动重试 3 次
- 重试延迟：1s → 2s → 4s（指数退避）
- 仍失败则记录到失败列表

**DOM 操作失败**：
- 记录错误信息
- 跳过该活动
- 继续处理下一个

**完全失败**（连续 5 个活动失败）：
- 暂停执行
- 提示用户："检测到多次失败，建议停止操作并检查"
- 用户可选择继续或停止

---

### 4. 进度计算

**预览阶段**：
```
进度 = 已遍历的页数 / 总页数
```

**执行阶段**：
```
进度 = 已遍历的页数 / 总页数
```

**说明**：
- 进度条显示翻页进度，而非活动处理进度
- 因为需要遍历所有页面才能找到符合条件的活动
- 单个页面可能包含多个或零个符合条件的活动

**预计剩余时间**：
```
平均翻页速度 = 已处理页数 / 已耗时
剩余时间 = 剩余页数 / 平均翻页速度
```

---

## ⚠️ 技术限制说明

### 1. 硬编码实现

**采用硬编码方式**：

- DOM 选择器写死在代码中
- 字段配置写死在代码中
- 没有配置文件
- 没有云端更新

**影响**：
- Strava 改版时需要更新插件代码并重新提交审核
- 修复周期：3-7 天

**应对**：
- 仔细测试，确保稳定性
- 预留多个备用选择器（降级方案）

---

### 2. 单条规则限制

**只支持单条规则**：

- 每次只能设置一个时间段
- 每次只能设置一组筛选条件
- 不支持"1-2月改鞋A，3-4月改鞋B"这种场景

**用户需知**：
- 如需多个时间段/不同配置，需要多次运行
- 每次运行需要重新配置

---

### 3. 反爬检测风险

**Strava 可能的反爬机制**：
- 检测 `isTrusted` 属性（识别脚本触发的事件）
- 检测鼠标轨迹的平滑度
- 检测操作频率和节奏

**应对措施**：
- 添加随机延迟（100-500ms）
- 操作之间有停顿
- 不使用过快的批量操作

**当前状态**：
- 竞品没有遇到反爬问题
- 参考竞品做法
- 如遇到问题再优化

---

## ✅ MVP 验收标准

### 功能完整性

✅ **场景支持**：
- 批量更新自行车
- 批量更新跑鞋
- 调整活动隐私设置
- 标记骑行类型

✅ **筛选条件**：
- 运动类型筛选生效
- 时间范围筛选生效（支持多时间段）
- 距离范围筛选生效（滑块控件）
- 骑行类型筛选生效（下拉多选）

✅ **操作流程**：
- 场景选择流程完整
- 配置流程完整
- 预览功能正常
- 执行功能正常
- 进度显示正常
- 结果反馈正常

✅ **任务管理**：
- 暂停和继续功能
- 任务状态保存
- 未完成任务提示
- 继续执行功能
- 任务详情查看
- 放弃任务功能

---

### 稳定性

✅ **基本稳定**：
- 不会修改错误的活动
- 不会修改错误的字段
- 失败时有明确提示

✅ **错误处理**：
- 网络错误自动重试
- DOM 操作失败能跳过
- 连续失败会暂停

✅ **数据安全**：
- 预览不修改数据
- 执行前有确认
- 失败活动有记录

---

### 用户体验

✅ **易用性**：
- 入口明显（批量更新按钮）
- 流程清晰（3 步配置）
- 提示友好（说明文字）

✅ **反馈及时**：
- 进度实时显示
- 成功/失败明确
- 剩余时间预估

✅ **可控性**：
- 可以预览
- 可以暂停
- 可以取消

---

### 前端要求

这份文档总结了我们关于 **Strava 批量编辑插件（MVP 版本）** 的所有前端设计与技术实现细节。请设计师和前端开发人员严格按照此指南执行，以确保产品的专业感、稳定性和独特性。

---

# 🛠️ Strava Bulk Edit 插件前端开发与设计规范 (V1.0-MVP)

## 1. 核心视觉目标：和而不同 (Coherent but Distinct)
*   **目标**：打造一个看起来像 Strava “Pro 增强版”的第三方工具层。
*   **设计原则**：一眼能与官方功能区分开（避免责任混淆），但设计语言（圆角、呼吸感）必须与 Strava 的现代运动风格同步。

---

## 2. 设计规范 (Design Specifications)

### 🎨 色彩体系
*   **主色 (Primary)**: **深靛蓝/深石板灰 (Deep Indigo/Slate)**。
    *   *目的*：建立“专业工具”、“黑科技控制台”的视觉印象，与官方橙色区隔。
*   **点缀色 (Accent)**: **Strava 橙 (`#FC4C02`)**。
    *   *用法*：仅用于核心操作按钮（如“开始执行”）、进度条、匹配成功的数值、当前步骤高亮。
*   **背景色**: 纯白 (`#FFFFFF`) 或 极浅灰 (`#F7F7F8`)。

### 📐 形状与间距
*   **圆角 (Radius)**: 统一使用 **`md` (8px)** 或 **`lg` (12px)**。严禁方正设计，保持运动感。
*   **按钮 (Button)**: 关键操作采用 **胶囊形 (Pill-shaped, radius="xl")**；次要操作使用大圆角。
*   **布局**: 采用“紧凑但有呼吸感”的间距。比 Strava 官方列表稍微松弛一些（增加 `verticalSpacing`）。

### ✨ 交互与层级 (Z-index & Animation)
*   **毛玻璃效果 (Overlay Blur)**: 打开插件 Modal 时，背景 Strava 页面必须开启 **`blur: 3px`** 遮罩。
*   **悬浮感**: 使用深而柔和的投影 (`shadow="xl"`)，让插件面板“浮”在页面之上。
*   **动效**: 
    *   面板进入：`slide-up` (从底部滑入)。
    *   步骤切换：水平淡入淡出。
    *   加载反馈：按钮进入 `loading` 状态，预览列表使用 `Skeleton` (骨架屏)。

---

## 3. 技术选型与实现 (Technical Stack)

### 🧱 框架与组件库
*   **核心框架**: React + Vite (推荐)。
*   **UI 库**: **Mantine (v7+)**。
    *   *理由*：自带丰富的 Hooks（`useLocalStorage` 存任务进度）和更现代的 UI 组件。
*   **CSS 方案**: **Tailwind CSS + CSS Modules**。
    *   *强制要求*：所有 CSS 类名必须加前缀（如 `sbe-`）或使用 **Shadow DOM**，严禁污染 Strava 全局样式。

### 📊 数据逻辑
*   **读取路径**: **Internal API First**。
    *   强制使用 `start_date_local_raw` (Unix 时间戳) 处理日期逻辑，严禁解析 DOM 里的本地化日期字符串。
*   **写入路径**: **DOM Simulation**。
    *   模拟点击“快速编辑” -> 修改字段 -> 触发 `input/change` 事件 -> 点击保存。
*   **分页处理**: 采用“翻页优化”逻辑。
    *   若当前页所有活动时间均早于用户设定的最早区间，自动停止翻页，节省性能。

### 🛡️ 稳定性与风控 (Safety)
*   **智能延迟**: 每一个保存操作之间，设置 **1.5s + 随机(0-1000ms)** 的抖动延迟，模拟人工节奏。
*   **串行步进**: 一次仅处理一个活动的保存，成功后再处理下一个。
*   **断点续传**: 使用 `chrome.storage.local` 实时保存任务状态（场景、进度、失败 ID），支持刷新后恢复。

---

## 4. 关键组件 UI 建议 (Mantine Components)

1.  **场景选择 (Scenario Picker)**:
    *   使用 `SimpleGrid` 展示卡片。
    *   每个卡片悬浮时有微弱缩放动效 (`scale: 1.02`)。
2.  **筛选配置 (Filters)**:
    *   **Slider**: 距离筛选需配合 `InputNumber` 联动，支持手动输入无上限值。
    *   **MultiSelect**: 运动类型和骑行类型支持标签移除。
3.  **预览表格 (Preview Table)**:
    *   使用 `Table` 组件，显示“修改前 → 修改后”对比。
    *   修改后数值使用橙色 `Badge` 标注。
4.  **进度反馈 (Progress)**:
    *   Modal 顶部使用 `Steps` 标记流程。
    *   中间使用水平 `Progress` 条，显示“处理页数 / 总页数”。

---

## 5. 开发任务优先级 (V1.0-MVP)

1.  **P0**: 完成 Mantine 全局主题配置（靛蓝+橙+圆角）。
2.  **P0**: 实现四个核心场景（自行车、跑鞋、隐私、骑行类型）的配置 UI。
3.  **P0**: 编写 `BatchEngine` 类，处理 DOM 模拟点击与分页逻辑。
4.  **P1**: 实现“预览结果”列表及其对比逻辑。
5.  **P1**: 实现“任务暂停/恢复”的本地存储逻辑。
6.  **P2**: 智能翻页优化与错误重试机制。

---

**致设计师**：请根据上述“深靛蓝+橙色”及圆角要求，出具一份高保真的场景配置及预览页原型。
**致前端开发**：请先搭建 MantineProvider 基础环境，并验证 `postMessage` 与 Iframe (用于未来详情页修改) 的通信可行性。


**PRD 文档完成！✅**

