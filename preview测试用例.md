# Preview流程测试用例框架

## 📋 测试概述

**测试对象**: Preview Engine (预览引擎)  
**测试目标**: 验证预览扫描功能的正确性、稳定性和性能  
**测试范围**: 从页面准备到匹配结果返回的完整流程  
**测试类型**: 功能测试、场景测试、边界测试、异常测试、性能测试、集成测试

---

## 🎯 测试维度

### 1. 功能测试 (Functional Tests)

#### 1.1 页面准备测试
- **TC-F-001**: 验证页面环境检查
  - 输入：当前在训练日志页面
  - 预期：环境检查通过
  
- **TC-F-002**: 验证回到第一页
  - 输入：当前在第N页（N > 1）
  - 预期：成功回到第1页
  
- **TC-F-003**: 验证时间降序排序
  - 输入：列表未按时间排序或升序排序
  - 预期：列表按时间降序排序

#### 1.2 页面扫描测试
- **TC-F-004**: 单页扫描
  - 输入：第1页有20个活动
  - 预期：成功扫描并返回20个活动
  
- **TC-F-005**: 多页扫描
  - 输入：共3页，每页20个活动
  - 预期：成功扫描所有60个活动
  
- **TC-F-006**: 页面翻页
  - 输入：当前第1页，有下一页
  - 预期：成功翻到第2页

#### 1.3 规则匹配测试
- **TC-F-007**: 运动类型筛选
  - 输入：筛选条件=骑行，页面有10个骑行+10个跑步
  - 预期：只匹配10个骑行活动
  
- **TC-F-008**: 日期范围筛选（单个范围）
  - 输入：2024-01-01 到 2024-01-31，页面有15个1月活动+5个2月活动
  - 预期：只匹配15个1月活动
  
- **TC-F-009**: 日期范围筛选（多个范围）
  - 输入：[2024-01-01~2024-01-31] OR [2024-03-01~2024-03-31]
  - 预期：只匹配1月和3月的活动，跳过2月
  
- **TC-F-010**: 距离范围筛选
  - 输入：10-50km，页面有5km、20km、60km各若干
  - 预期：只匹配10-50km范围内的活动
  
- **TC-F-011**: 骑行类型筛选
  - 输入：筛选Race和Workout，页面有Race、Workout、Commute各若干
  - 预期：只匹配Race和Workout类型
  
- **TC-F-012**: 组合条件筛选（AND逻辑）
  - 输入：骑行 AND 2024年1月 AND 20-100km AND Race
  - 预期：只匹配同时满足所有条件的活动

#### 1.4 智能优化测试
- **TC-F-013**: 智能停止分页（活动早于时间范围）
  - 输入：日期范围=2024-06-01~2024-06-30，当前页所有活动都在2024-05-31之前
  - 预期：停止翻页，不再继续扫描
  
- **TC-F-014**: 不触发智能停止（仍在范围内）
  - 输入：日期范围=2024-06-01~2024-06-30，当前页有活动在范围内
  - 预期：继续翻页扫描

#### 1.5 缓存机制测试
- **TC-F-015**: 缓存命中
  - 输入：第2页数据已在缓存中
  - 预期：直接从缓存读取，不等待API
  
- **TC-F-016**: 缓存未命中
  - 输入：第3页数据不在缓存中
  - 预期：等待API响应并返回数据

#### 1.6 进度回调测试
- **TC-F-017**: 进度回调正常触发
  - 输入：扫描过程中
  - 预期：每页扫描完成后触发进度回调，包含正确的页码、扫描数、匹配数
  
- **TC-F-018**: 完成状态回调
  - 输入：扫描完成
  - 预期：触发完成状态回调，status='completed'

---

### 2. 场景测试 (Scenario Tests)

#### 2.1 场景S1：批量更新自行车
- **TC-S1-001**: 骑行活动筛选
  - 输入：sportTypes=['Ride'], 页面有骑行和跑步
  - 预期：只匹配骑行活动
  
- **TC-S1-002**: 距离范围筛选（0-300km）
  - 输入：distanceRange=[0, 300], 页面有5km、150km、350km
  - 预期：只匹配0-300km的活动
  
- **TC-S1-003**: 骑行类型可选筛选
  - 输入：rideTypes=['Race', 'Workout']
  - 预期：只匹配Race和Workout类型的骑行
  
- **TC-S1-004**: 多时间段筛选
  - 输入：dateRanges=[{2024-01}, {2024-06}]
  - 预期：匹配1月和6月的骑行活动

#### 2.2 场景S2：批量更新跑鞋
- **TC-S2-001**: 跑步活动筛选
  - 输入：sportTypes=['Run']
  - 预期：只匹配跑步活动
  
- **TC-S2-002**: 距离范围筛选（0-40km）
  - 输入：distanceRange=[0, 40], 页面有5km、25km、50km
  - 预期：只匹配0-40km的活动
  
- **TC-S2-003**: 无骑行类型筛选
  - 输入：跑步场景
  - 预期：rideTypes筛选不生效

#### 2.3 场景S3：调整活动隐私
- **TC-S3-001**: 多运动类型筛选
  - 输入：sportTypes=['Ride', 'Run']
  - 预期：匹配骑行和跑步活动
  
- **TC-S3-002**: 无距离筛选
  - 输入：隐私场景
  - 预期：不限制距离范围
  
- **TC-S3-003**: 只时间范围筛选
  - 输入：dateRanges=[{2024-01-01~2024-12-31}]
  - 预期：匹配指定时间范围内的所有运动类型

#### 2.4 场景S4：标记骑行类型
- **TC-S4-001**: 骑行活动筛选
  - 输入：sportTypes=['Ride']
  - 预期：只匹配骑行活动
  
- **TC-S4-002**: 距离范围筛选（0-300km）
  - 输入：distanceRange=[0, 300]
  - 预期：只匹配0-300km的活动
  
- **TC-S4-003**: 标记特定类型
  - 输入：需要标记为Race的骑行活动
  - 预期：匹配所有符合条件的骑行（不限制原有类型）

---

### 3. 边界测试 (Boundary Tests)

#### 3.1 数据边界
- **TC-B-001**: 空活动列表
  - 输入：页面没有任何活动
  - 预期：返回空匹配列表，totalScanned=0
  
- **TC-B-002**: 单个活动
  - 输入：只有1个活动，且匹配规则
  - 预期：返回1个匹配活动
  
- **TC-B-003**: 大量活动（200+页）
  - 输入：超过200页的活动列表
  - 预期：能够正常扫描，不崩溃
  
- **TC-B-004**: 全部不匹配
  - 输入：100个活动，规则筛选后0个匹配
  - 预期：返回空匹配列表，totalScanned=100

#### 3.2 条件边界
- **TC-B-005**: 距离=0km
  - 输入：distanceRange=[0, 0], 页面有0km活动
  - 预期：匹配0km活动
  
- **TC-B-006**: 距离=无限大
  - 输入：distanceRange=[0, 999999]
  - 预期：匹配所有距离
  
- **TC-B-007**: 日期范围=同一天
  - 输入：start=2024-01-01, end=2024-01-01
  - 预期：只匹配1月1日的活动
  
- **TC-B-008**: 日期范围=跨年
  - 输入：start=2023-12-01, end=2024-01-31
  - 预期：匹配跨年的活动

#### 3.3 页面边界
- **TC-B-009**: 只有第一页（无下一页）
  - 输入：总共20个活动，只有1页
  - 预期：扫描完第1页后正常结束
  
- **TC-B-010**: 最后一页只有1个活动
  - 输入：第N页只有1个活动
  - 预期：正常扫描该活动
  
- **TC-B-011**: 活动数正好是20的倍数
  - 输入：正好60个活动，3页
  - 预期：正常扫描所有页面

#### 3.4 规则边界
- **TC-B-012**: 无任何筛选条件
  - 输入：空规则（conditions=[]）
  - 预期：匹配所有活动
  
- **TC-B-013**: 所有条件都disabled
  - 输入：所有条件enabled=false
  - 预期：匹配所有活动
  
- **TC-B-014**: 时间范围为空数组
  - 输入：dateRanges=[]
  - 预期：不限制时间，匹配所有活动

---

### 4. 异常测试 (Exception Tests)

#### 4.1 网络异常
- **TC-E-001**: API响应超时
  - 输入：API响应时间超过10秒
  - 预期：触发重试机制，最多3次
  
- **TC-E-002**: API返回错误
  - 输入：API返回4xx/5xx错误
  - 预期：记录错误，尝试重试或跳过
  
- **TC-E-003**: API返回空数据
  - 输入：API返回success但activities=[]
  - 预期：视为空页，正常处理

#### 4.2 页面异常
- **TC-E-004**: 页面未加载完成就开始扫描
  - 输入：document.readyState != 'complete'
  - 预期：等待页面加载或返回错误
  
- **TC-E-005**: 翻页失败
  - 输入：点击下一页按钮失败
  - 预期：记录错误，停止扫描或重试
  
- **TC-E-006**: 页码解析失败
  - 输入：页码元素内容异常
  - 预期：默认为第1页，继续执行

#### 4.3 数据异常
- **TC-E-007**: 活动缺少必要字段
  - 输入：activity没有start_time或distance_raw
  - 预期：该活动不匹配，但不影响其他活动
  
- **TC-E-008**: 日期格式错误
  - 输入：start_time='invalid-date'
  - 预期：该活动不匹配，记录警告
  
- **TC-E-009**: 距离值异常（负数）
  - 输入：distance_raw=-100
  - 预期：该活动不匹配

#### 4.4 规则异常
- **TC-E-010**: 规则验证失败
  - 输入：无效的规则配置
  - 预期：返回错误，不执行扫描
  
- **TC-E-011**: 条件值类型错误
  - 输入：sportTypes='Ride'（应该是数组）
  - 预期：条件验证失败，不匹配活动

#### 4.5 错误恢复
- **TC-E-012**: 第一页扫描失败
  - 输入：第1页API调用失败
  - 预期：直接终止，返回错误
  
- **TC-E-013**: 中间页扫描失败
  - 输入：第3页API调用失败，重试3次后仍失败
  - 预期：根据stopOnError设置决定是否继续
  
- **TC-E-014**: 连续3页失败
  - 输入：连续3页都扫描失败
  - 预期：终止扫描，返回已匹配的活动
  
- **TC-E-015**: 单页重试成功
  - 输入：第2页第一次失败，第二次重试成功
  - 预期：正常返回该页数据，继续扫描

---

### 5. 性能测试 (Performance Tests)

#### 5.1 扫描速度
- **TC-P-001**: 单页扫描耗时
  - 输入：20个活动的单页
  - 预期：扫描时间 < 3秒
  
- **TC-P-002**: 多页扫描耗时
  - 输入：5页共100个活动
  - 预期：总时间 < 20秒（平均每页4秒）
  
- **TC-P-003**: 缓存加速效果
  - 输入：缓存命中的页面
  - 预期：扫描时间 < 100ms

#### 5.2 内存使用
- **TC-P-004**: 大量活动内存占用
  - 输入：扫描1000个活动
  - 预期：内存占用 < 50MB
  
- **TC-P-005**: 匹配活动数组增长
  - 输入：匹配500个活动
  - 预期：内存增长平稳，无泄漏

#### 5.3 智能优化效果
- **TC-P-006**: 智能停止节省时间
  - 输入：日期范围=最近1个月，总活动=1年
  - 预期：停止分页后节省90%+扫描时间
  
- **TC-P-007**: 缓存命中率
  - 输入：同一规则二次扫描
  - 预期：缓存命中率 > 80%

---

### 6. 集成测试 (Integration Tests)

#### 6.1 与规则引擎集成
- **TC-I-001**: FilterConfig转RuleConfig
  - 输入：完整的FilterConfig
  - 预期：正确编译为RuleConfig
  
- **TC-I-002**: 规则评估正确性
  - 输入：activity和rule
  - 预期：evaluateRule返回正确的匹配结果

#### 6.2 与页面管理器集成
- **TC-I-003**: 页面准备流程
  - 输入：任意页面状态
  - 预期：preparePageForExecution成功
  
- **TC-I-004**: 翻页流程
  - 输入：第1页
  - 预期：goToNextPage成功跳转到第2页
  
- **TC-I-005**: 页码获取
  - 输入：任意页码
  - 预期：getCurrentPage返回正确页码

#### 6.3 与API监听器集成
- **TC-I-006**: API缓存同步
  - 输入：页面加载触发API调用
  - 预期：缓存正确存储响应数据
  
- **TC-I-007**: 等待API响应
  - 输入：缓存未命中
  - 预期：waitForNextResponse正确返回API数据
  
- **TC-I-008**: 监听器生命周期
  - 输入：预览开始和结束
  - 预期：监听器持续运行，不停止

#### 6.4 与UI组件集成
- **TC-I-009**: 进度回调传递
  - 输入：onProgress回调函数
  - 预期：UI正确显示进度信息
  
- **TC-I-010**: 匹配结果展示
  - 输入：预览完成返回matchedActivities
  - 预期：UI正确展示活动列表和对比信息
  
- **TC-I-011**: 错误信息显示
  - 输入：预览失败
  - 预期：UI显示错误信息和部分结果

#### 6.5 端到端测试
- **TC-I-012**: 完整预览流程（骑行场景）
  - 输入：选择S1场景，设置筛选条件，点击预览
  - 预期：完整流程成功，返回正确匹配结果
  
- **TC-I-013**: 完整预览流程（跑步场景）
  - 输入：选择S2场景，设置筛选条件，点击预览
  - 预期：完整流程成功，返回正确匹配结果
  
- **TC-I-014**: 预览后执行
  - 输入：预览完成，点击开始执行
  - 预期：正确传递匹配活动到执行引擎
  
- **TC-I-015**: 预览后返回修改
  - 输入：预览完成，点击返回修改
  - 预期：保留原有配置，允许用户修改

---

## 🧪 测试数据准备

### 7.1 测试账号数据要求
- **基础数据集**：至少包含以下活动类型和数量
  - 骑行活动：60+ 个（跨越3+页）
  - 跑步活动：40+ 个（跨越2+页）
  - 活动时间：跨越12+个月
  - 距离范围：5km - 300km 分布均匀
  - 骑行类型：包含Race、Workout、Commute等

### 7.2 Mock数据结构
```typescript
// 标准测试活动数据
const mockActivity = {
  id: 123456,
  sport_type: 'Ride',
  name: '测试骑行',
  start_time: '2024-01-15T10:00:00+0000',
  distance_raw: 50000, // 50km
  moving_time_raw: 7200, // 2小时
  visibility: 'everyone',
  ride_type: 'Workout'
}

// 边界测试数据
const edgeCaseActivities = [
  { ...mockActivity, distance_raw: 0 },        // 0km
  { ...mockActivity, distance_raw: 999999999 }, // 超大距离
  { ...mockActivity, start_time: null },       // 缺少时间
  { ...mockActivity, sport_type: '' },         // 空运动类型
]
```

---

## 📊 测试执行策略

### 8.1 测试优先级
- **P0 - 核心功能** (必须通过)
  - 页面准备、扫描、规则匹配、结果返回
  - TC-F-001 至 TC-F-012
  
- **P1 - 重要功能** (高优先级)
  - 智能优化、缓存机制、错误处理
  - TC-F-013 至 TC-F-018, TC-E-001 至 TC-E-015
  
- **P2 - 场景验证** (中优先级)
  - 4个场景的完整测试
  - TC-S1-001 至 TC-S4-003
  
- **P3 - 边界和性能** (低优先级)
  - 边界测试、性能测试
  - TC-B-001 至 TC-P-007

### 8.2 测试环境
- **浏览器**: Chrome 120+, Edge 120+
- **操作系统**: Windows, macOS
- **网络环境**: 正常网络、慢速网络（3G）、不稳定网络
- **Strava账号**: 测试专用账号，包含足够的测试数据

### 8.3 测试方法
- **手动测试**: 核心功能和场景测试
- **自动化测试**: 边界测试和回归测试（后续实现）
- **性能监控**: 使用Chrome DevTools监控耗时和内存

### 8.4 验收标准
- **功能完整性**: P0和P1测试用例100%通过
- **场景覆盖**: 4个场景测试100%通过
- **错误处理**: 异常测试80%+通过
- **性能要求**: 性能测试达到预期指标
- **集成测试**: 端到端测试100%通过

---

## 📝 测试记录模板

### 9.1 测试用例执行记录
```
测试用例ID: TC-F-001
测试标题: 验证页面环境检查
执行日期: 2024-01-15
执行人员: [测试人员]
测试环境: Chrome 120 / macOS

【测试步骤】
1. 打开Strava训练日志页面
2. 调用validatePageEnvironment()
3. 检查返回结果

【实际结果】
✅ 通过 / ❌ 失败

【预期结果】
{ ready: true, errors: [] }

【问题描述】
（如有问题，详细描述）

【截图/日志】
（附上相关截图或控制台日志）
```

### 9.2 缺陷报告模板
```
缺陷ID: BUG-001
严重程度: 高/中/低
发现时间: 2024-01-15
发现人员: [测试人员]

【缺陷描述】
简要描述问题现象

【复现步骤】
1. ...
2. ...
3. ...

【预期结果】
应该...

【实际结果】
实际...

【环境信息】
- 浏览器: Chrome 120
- 操作系统: macOS
- 插件版本: v1.0.0

【影响范围】
影响的功能或场景

【修复建议】
（可选）建议的修复方案
```

---

## 🎯 测试目标和里程碑

### 第一阶段：核心功能测试（Week 1）
- [ ] 完成所有P0测试用例
- [ ] 完成页面管理器集成测试
- [ ] 验证基本的规则匹配逻辑

### 第二阶段：场景和异常测试（Week 2）
- [ ] 完成4个场景的完整测试
- [ ] 完成异常处理测试
- [ ] 验证错误恢复机制

### 第三阶段：性能和集成测试（Week 3）
- [ ] 完成性能测试
- [ ] 完成端到端集成测试
- [ ] 完成回归测试

### 验收标准
- [ ] 所有P0和P1测试用例通过率 100%
- [ ] 场景测试通过率 100%
- [ ] 异常测试通过率 ≥ 80%
- [ ] 性能指标达到预期
- [ ] 无P0/P1级别的未修复缺陷

---

## 📌 注意事项

1. **不破坏真实数据**
   - 使用测试专用账号
   - Preview流程不修改任何数据，可放心测试
   
2. **测试数据清理**
   - 测试完成后清理缓存
   - 必要时重置测试账号数据
   
3. **日志收集**
   - 每次测试开启Console日志记录
   - 保存关键的网络请求和响应
   
4. **版本管理**
   - 记录每次测试的插件版本
   - 回归测试时使用相同版本
   
5. **测试隔离**
   - 每个测试用例独立执行
   - 避免测试之间相互影响

---

## 🔗 相关文档

- [SimplePRD.md](./SimplePRD.md) - 产品需求文档
- [preview执行流程.md](./preview执行流程.md) - Preview流程详细说明
- [src/engine/previewEngine.ts](./src/engine/previewEngine.ts) - Preview引擎源码
- [src/core/ruleEngine.ts](./src/core/ruleEngine.ts) - 规则引擎源码
- [src/core/pageManager.ts](./src/core/pageManager.ts) - 页面管理器源码

---

**文档版本**: v1.0  
**创建日期**: 2026-01-15  
**最后更新**: 2026-01-15  
**维护人员**: Stone
